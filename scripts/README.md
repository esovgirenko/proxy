# Скрипты установки и управления

## Описание скриптов

### install.sh
**Автоматическая установка прокси-сервера с нуля**

Полностью автоматизированная установка, которая:
- Проверяет систему и права доступа
- Устанавливает все зависимости
- Настраивает Docker, Nginx, Firewall
- Создает и настраивает все необходимые файлы
- Инициализирует базу данных
- Запускает приложение

**Использование:**
```bash
chmod +x scripts/install.sh
sudo ./scripts/install.sh
```

**Когда использовать:**
- Первая установка на новом сервере
- Полная автоматизация установки
- Нужна интерактивная настройка (запрос домена)

---

### deploy.sh
**Автоматическое развертывание (файлы уже на сервере)**

Быстрое развертывание, когда файлы проекта уже скопированы в `/opt/proxy`.

**Использование:**
```bash
chmod +x scripts/deploy.sh
sudo ./scripts/deploy.sh
```

**Когда использовать:**
- Файлы проекта уже на сервере
- Обновление существующей установки
- Автоматизация CI/CD

---

### setup_ssl.sh
**Настройка SSL сертификатов через Let's Encrypt**

Автоматическая настройка SSL сертификатов и конфигурации Nginx для HTTPS.

**Использование:**
```bash
chmod +x scripts/setup_ssl.sh
sudo ./scripts/setup_ssl.sh your-domain.com your-email@example.com
```

**Параметры:**
- `your-domain.com` - доменное имя (обязательно)
- `your-email@example.com` - email для Let's Encrypt (опционально)

**Что делает:**
- Устанавливает certbot (если не установлен)
- Получает SSL сертификат
- Настраивает Nginx для HTTPS
- Настраивает автоматическое обновление сертификатов

---

### backup.sh
**Резервное копирование базы данных**

Создает сжатый бэкап базы данных PostgreSQL.

**Использование:**
```bash
chmod +x scripts/backup.sh
sudo ./scripts/backup.sh
```

**Что делает:**
- Создает сжатый дамп базы данных
- Сохраняет в `/opt/proxy/backups/`
- Удаляет старые бэкапы (старше 7 дней)

**Автоматизация:**
Скрипт `install.sh` автоматически настраивает cron для ежедневного бэкапа в 2:00.

---

## Сравнение скриптов

| Скрипт | Когда использовать | Интерактивность | Полнота |
|--------|-------------------|-----------------|---------|
| `install.sh` | Новая установка | ✅ Да (запрос домена) | ✅ Полная |
| `deploy.sh` | Файлы уже на сервере | ❌ Нет | ⚠️ Частичная |
| `setup_ssl.sh` | Настройка SSL | ❌ Нет | ✅ Полная |
| `backup.sh` | Резервное копирование | ❌ Нет | ✅ Полная |

## Рекомендуемый порядок установки

### Для новой установки:

1. **Установка:**
   ```bash
   sudo ./scripts/install.sh
   ```

2. **Настройка SSL:**
   ```bash
   sudo ./scripts/setup_ssl.sh your-domain.com
   ```

3. **Готово!** ✅

### Для обновления:

1. **Остановка:**
   ```bash
   cd /opt/proxy
   docker-compose down
   ```

2. **Обновление файлов:**
   ```bash
   # Обновите файлы проекта
   ```

3. **Запуск:**
   ```bash
   docker-compose up -d
   docker-compose exec app alembic upgrade head
   ```

## Логирование

Все скрипты логируют свою работу:

- **install.sh**: `/var/log/proxy_install.log`
- **backup.sh**: `/var/log/proxy_backup.log` (при запуске через cron)

## Безопасность

Все скрипты:
- ✅ Проверяют права root перед выполнением
- ✅ Создают резервные копии перед изменением файлов
- ✅ Валидируют входные данные
- ✅ Логируют все действия

## Устранение неполадок

### Скрипт не запускается

```bash
# Проверьте права
chmod +x scripts/*.sh

# Проверьте права root
sudo ./scripts/install.sh
```

### Ошибки при установке

```bash
# Проверьте логи
tail -f /var/log/proxy_install.log

# Проверьте системные логи
journalctl -xe
```

### Проблемы с SSL

```bash
# Проверьте доступность домена
curl -I http://your-domain.com

# Проверьте DNS
nslookup your-domain.com

# Ручное получение сертификата
certbot certonly --standalone -d your-domain.com
```

## Дополнительная информация

- **Подробная инструкция**: [../INSTALL.md](../INSTALL.md)
- **Быстрая установка**: [../INSTALL_QUICK.md](../INSTALL_QUICK.md)
- **Развертывание**: [../DEPLOY.md](../DEPLOY.md)
